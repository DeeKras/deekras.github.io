<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>DeeKras.com</title>
    <meta name="description" content="">
    <meta name="author" content="Dee Kras">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://www.deekras.com/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://www.deekras.com/theme/bootstrap.min.css" rel="stylesheet">
    <link href="http://www.deekras.com/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://www.deekras.com/theme/local.css" rel="stylesheet">
    <link href="http://www.deekras.com/theme/pygments.css" rel="stylesheet">

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="feeds/all.atom.xml" rel="alternate" title="DeeKras.com" type="application/atom+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://www.deekras.com">DeeKras.com</a>

        <div class="nav-collapse">
        <ul class="nav">
            
        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
    <div class='article'>
        <div class="content-title">
            <h1>Basic SQLAlchemy</h1>
Sat 20 December 2014

by <a class="url fn" href="http://www.deekras.com/author/dee-kras.html">Dee Kras</a>
 


        </div>
	
        <div><h2>First, why SQLAlchemy is powerful.</h2>
<p>There's a whole set of features of SQLAlchemy listed in their <a href="http://www.sqlalchemy.org/features.html">docs</a>. I have found that using SQLAlchemy instead of SQLlite has made it much easier to access the data, since data is saved as a class. And writing methods and queries on that data is simpler than straight up SQL.</p>
<h3>Some very basics about how it works.</h3>
<p>Some very important points <a href="http://alextechrants.blogspot.com/2013/11/10-common-stumbling-blocks-for.html">here</a></p>
<p>The imports:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">backref</span><span class="p">,</span> <span class="n">sessionmaker</span>
</pre></div>


<p>To set things up:</p>
<div class="highlight"><pre><span class="n">db</span> <span class="o">=</span> <span class="s">&#39;sqlite:///membership.db&#39;</span>  <span class="c">#your database</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="c">#you can name it anything. convention names it &#39;engine&#39;.</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>  <span class="c">#you can name it anything. convention names it &#39;session&#39;.</span>
</pre></div>


<h3>A quick background to what this little program is about:</h3>
<p>This program is a webform. (At this point, using regular Flask forms. Will refactor to use WTForms.)
   - A new user <em>inquires</em> about membership.<br />
        - She fills in some basic info about herself.
        - The <code>member_id</code> is automatically set.
        - The <code>inquiry_date</code> is set to current date/ time.</p>
<ul>
<li>
<p>The inquirer becomes a member (activate).
        - She adds some more info (email/ password).
        - The <code>active_date</code> is set to current date/ time.
        - <code>is_active</code> is set to <code>true</code>.</p>
</li>
<li>
<p>The active member can unsubscribe (deactivate).
        - The <code>inactive_date</code> is set to current date/ time.
        - <code>is_active</code> is set to <code>false</code>.</p>
</li>
</ul>
<p>Set up the Class:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Member</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;members&#39;</span>

    <span class="n">member_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">inquiry_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">active__date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">inactive__date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<p>The class is based on the <code>Base</code> object.  It must contain the <code>__tablename__</code>. And at least one column that is the primary key.</p>
<p>[About <code>primary_key</code>:  A primary key is unique. That is no other row in that column has the same data.  It is the field that identifies the row as unique.  In this example, each member has a unique member_id. ]</p>
<p>And now to add some methods to the <code>Member</code> class:</p>
<div class="highlight"><pre>    <span class="k">def</span> <span class="nf">add_to_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inactive_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>


<p><code>session.add(self)</code>: This method will (attempt to) create a new row in the database and add the data to that row.  The <code>primary_key</code> must be unique. In this case, it is unique, since we are using '<code>autoincrement' to create the</code>member_id`.</p>
<p>(We can use <code>add_all([list of new rows])</code> to create several rows at once.)</p>
<p>Later when we actually call any of these methods that make changes (additions, changes or deletions) to the database, we will also have to <code>commit()</code> it, or the data will not be saved. <code>session.commit()</code>.</p>
<p>So for example, the user is on the 'I'm interested' page and enters her last name, first name and email address and then hits 'submit'.  The function might be something like this:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">add_interested</span><span class="p">():</span>

    <span class="n">last_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;last_name&#39;</span><span class="p">]</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;first_name&#39;</span><span class="p">]</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email_address&#39;</span><span class="p">]</span>

    <span class="n">Member</span><span class="p">(</span><span class="n">last_name</span><span class="o">=</span><span class="n">last_name</span><span class="p">,</span> 
           <span class="n">first_name</span><span class="o">=</span><span class="n">first_name</span><span class="p">,</span> 
           <span class="n">email_address</span><span class="o">=</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_db</span><span class="p">()</span>

    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">It</span> <span class="ow">is</span> <span class="n">interesting</span> <span class="n">to</span> <span class="n">see</span> <span class="n">your</span> <span class="n">data</span><span class="o">.</span>  <span class="n">For</span> <span class="n">that</span> <span class="n">we</span> <span class="n">use</span> <span class="n">queries</span><span class="o">.</span>  <span class="n">Here</span> <span class="ow">is</span> <span class="n">a</span> <span class="nb">super</span> <span class="n">simple</span> <span class="n">one</span><span class="p">:</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>

<span class="k">def</span> <span class="nf">display_members</span><span class="p">():</span>
    <span class="n">members</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Member</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">member</span><span class="o">.</span><span class="n">email_address</span><span class="p">,</span> <span class="n">member</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span> <span class="n">member</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> 
                <span class="n">member</span><span class="o">.</span><span class="n">active_date</span><span class="p">,</span> <span class="n">member</span><span class="o">.</span><span class="n">cell_phone</span>
</pre></div>


<p>The basic syntax for a query in SQLAlchemy is:
<code>session.query(whatever you are searching)</code> *This will need a 'return results'argument at the end. See below.
You can search through a class <code>session.query(Member)</code>
or you can list a few fields <code>session.query(Member.last_name, Member.first_name)</code></p>
<p><code>session</code> is the same 'session' that we declared at the very beginning.
There are many different arguments.</p>
<p><strong>Return results</strong>
At the very end - which indicates how many results to return - you can use:
   - <code>.all()</code>
        - returns all results. As a list of tuples.
   - <code>.first()
        - returns the first result. As a tuple.
        - if there were no results, returns</code>None<code>.
   -</code>.limit(limit)<code>ex:</code>limit(3)<code>will return 3
        - returns the 'limit' number of rows. As a list of tuples.
   -</code>.one()<code>- returns exactly one result. As a tuple.
        - if there are more results than 1, raises</code>MultipleResultsFound<code>- if there were no results, raises</code>NoResultFound<code>-</code>.scalar()<code>- returns the first column of the first result ex:</code>session.query(Item.id, Item.name).scalar()<code>will return just the value of Item.id (the first column)
        - if there are more results than 1, raises</code>MultipleResultsFound<code>- if there were no results, returns</code>None`</p>
<p>Other more common arguments are:
   - <code>.filter()</code> or <code>.filter_by()</code>
        - criterion to filter results
        - <code>filter</code> uses SQL expressions and is more pythonic. So uses <code>==</code> (double equal). ex: <code>.filter(Member.last_name == 'Silver')</code>
        - <code>filter_by</code> uses keyword expressions. So uses <code>=</code> (single equal). ex: <code>.filter_by(Member.last_name = 'Silver')</code>
        - use a comma to add more criteria, ex: <code>.filter(Member.last_name == 'Silver', Member.first_name = 'Mark')</code></p>
<ul>
<li><code>.order_by()</code>
        - the results will be sorted in the order specified. ex: <code>.order_by(Member.active_date)</code> will be sorted by <code>active_date</code></li>
<li><code>.group_by</code>
        - the results will be grouped by the criterion. returns a set, based on the columns indicated. ex: <code>.group_by(Member.active_date)</code> will group by <code>active_date</code> and return one row for each active date in the table, even if there are many of the same active date in the table</li>
<li><code>.count()</code>
        - returns a count (the number) of rows this query would return</li>
</ul>
<p>And then there are a whole set of different types of 'joins' for working with 2 tables that have a relationship. Will explore these in a separate post about relationships between tables.</p>
<p>That's the very very basic. It gets much more interesting and useful, when we start adding relationships between the tables. And making the queries a bit more complex.  More next time.</p></div>
	
        <hr>

    </div>
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="http://www.deekras.com/">Archives</a>
                <li><a href="http://www.deekras.com/tags.html">Tags</a>



                <li><a href="http://www.deekras.com/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="http://www.deekras.com/category/about.html">About</a></li>
                <li><a href="http://www.deekras.com/category/about-python.html">About  Python</a></li>
                <li><a href="http://www.deekras.com/category/python.html">Python</a></li>
                   
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                <li><a href="http://python.org/">Python.org</a></li>
                <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="deekras">github</a></li>
                <li><a href="#">Another social link</a></li>
            </ul>
            </div>
            </div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="http://www.deekras.com">DeeKras.com</a> &copy; Dee Kras 2012</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
 
</body>
</html>